<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="https://i.postimg.cc/qB1WsNqM/IMG-9894.jpg">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bubblen</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #f2f2f2;
            --chat-bg: #abc1d1;
            --primary-blue: #007aff;
            --artist-gradient: linear-gradient(135deg, #6a5acd, #87cefa); /* ç´«è“åˆ°æµ…è“ */
            --border-gray: #e0e0e0;
            --heart-pink: #ff69b4;
            --heart-dark-pink: #d14788;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #fff;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ é¢„ç•™ */
        .status-bar-spacer {
            height: 59px; /* iPhone notch area */
            background: transparent;
            width: 100%;
            flex-shrink: 0;
            z-index: 1000;
        }

        /* é€šç”¨éšè—/æ˜¾ç¤º */
        .page {
            flex: 1;
            overflow-y: auto;
            display: none;
            position: relative;
            background: #fff;
        }
        .page.active {
            display: block;
        }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            height: 60px;
            border-top: 1px solid var(--border-gray);
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #fff;
            flex-shrink: 0;
            z-index: 999;
        }

        .nav-item {
            font-size: 24px;
            color: #ccc;
            cursor: pointer;
            position: relative;
        }

        .nav-item.active {
            color: #000;
        }

        /* ä¿¡æ¯å›¾æ ‡ç‰¹æ®Šæ•ˆæœ */
        .nav-item.chat-icon.active .fa-comment {
            font-weight: 900; /* Solid */
        }
        .nav-item.chat-icon.active::after {
            content: 'â€¢â€¢';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            letter-spacing: 2px;
        }

        /* ==================== PAGE 1: FRIENDS ==================== */
        .header-bar {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end; /* Align bottom */
            height: 50px;
        }

        .header-title {
            font-size: 24px;
            font-weight: 800; /* ç²—ä½“ */
        }

        .header-icons {
            display: flex;
            gap: 15px;
            margin-bottom: 5px; /* æ¯” Friends å¾€ä¸Šä¸€ç‚¹ */
            font-size: 18px;
        }

        .profile-section {
            padding: 20px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-gray);
        }

        /* ä¿®æ”¹ï¼šæ‰€æœ‰å¤´åƒæ”¹ä¸ºåœ†å½¢ */
        .small-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%; /* æ”¹ä¸ºåœ†å½¢ */
            background-color: var(--primary-blue); /* é»˜è®¤è“è‰² */
            object-fit: cover;
            margin-right: 15px;
            cursor: pointer;
        }

        .profile-info h3 {
            font-size: 16px;
        }
        .profile-info p {
            color: gray;
            font-size: 12px;
            margin-top: 4px;
        }

        /* ä¸ªäººä¸»é¡µç¼–è¾‘é¡µé¢ (Overlay) */
        #edit-profile-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #999999; /* é»˜è®¤æµ…ç°è‰² */
            background-size: cover;
            background-position: center;
            z-index: 2000;
            display: none;
        }

        .edit-close-btn {
            position: absolute;
            top: 50px;
            left: 20px;
            font-size: 24px;
            color: white;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
            cursor: pointer;
        }

        .profile-content-wrapper {
            position: absolute;
            bottom: 15%;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .artist-badge-row {
            display: flex;
            align-items: center;
            gap: 6px; /* æ›´ç´§å‡‘ */
            margin-bottom: 5px;
            margin-top: 15px;
        }

        .artist-badge {
            background: var(--artist-gradient);
            color: white;
            padding: 1px 8px; /* æ›´ç´§å‡‘ */
            border-radius: 12px; /* æ”¹ä¸ºæ¤­åœ†å½¢ */
            font-size: 10px;
            font-weight: bold;
            letter-spacing: 0.5px; /* å‡å°å­—æ¯é—´è· */
            min-width: 55px; /* ç¡®ä¿è¶³å¤Ÿé•¿ */
            text-align: center;
        }

        .profile-name-display {
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            margin-left: 2px; /* æ›´ç´§å‡‘ */
        }

        .profile-desc-display {
            color: #ddd;
            font-size: 12px;
            margin-bottom: 10px; /* æ›´ç´§å‡‘ */
        }

        .white-border-box {
            border: 1px solid rgba(255, 255, 255, 0.5); /* æ›´é€æ˜ */
            background: transparent;
            padding: 3px 10px; /* æ›´å° */
            color: white;
            font-size: 11px; /* æ›´å° */
            border-radius: 15px; /* ç¨å¾®åœ†ä¸€ç‚¹ */
            margin-bottom: 8px;
            min-width: 140px; /* æ›´å° */
            max-width: 180px; /* æ›´å° */
            text-align: center;
        }

        /* éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† */
        input[type="file"] {
            display: none;
        }

        /* ==================== PAGE 2: CHATS ==================== */
        .chat-list-item {
            display: flex;
            padding: 15px 20px;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        /* ä¿®æ”¹ï¼šèŠå¤©åˆ—è¡¨å¤´åƒæ”¹ä¸ºåœ†å½¢ */
        .chat-list-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%; /* æ”¹ä¸ºåœ†å½¢ */
            background: #eee;
            margin-right: 15px;
            object-fit: cover;
        }

        /* èŠå¤©å®¤é¡µé¢ */
        #chat-room-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 1500;
            display: none;
            flex-direction: column;
        }

        .chat-room-header {
            height: 60px; /* å¢åŠ é«˜åº¦ */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            background: rgba(255,255,255,0.9);
            border-bottom: 1px solid #eee;
            margin-top: 10px; /* å¢åŠ ä¸Šè¾¹è·ï¼Œä½¿å…¶é ä¸‹ */
        }

        .chat-room-bg {
            flex: 1;
            background-color: var(--chat-bg);
            background-size: cover;
            background-position: center;
            position: relative;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        /* å¤©æ•°æ˜¾ç¤º */
        .days-counter {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.8);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            z-index: 10;
        }
        .days-heart {
            color: var(--heart-pink); /* æµ…ç²‰ */
        }
        .days-heart i {
             background: -webkit-linear-gradient(45deg, var(--heart-pink) 50%, var(--heart-dark-pink) 50%);
             -webkit-background-clip: text;
             -webkit-text-fill-color: transparent;
        }
        /* æ¶ˆæ¯åŒºåŸŸ */
        .messages-area {
            flex: 1;
            padding: 40px 10px 10px 10px;
            display: flex;
            flex-direction: column;
            gap: 8px; /* æ›´ç´§å‡‘ */
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .msg-row {
            display: flex;
            margin-bottom: 8px; /* æ›´ç´§å‡‘ */
            width: 100%;
        }

        /* è‡ªå·±çš„æ¶ˆæ¯ (Default right) */
        .msg-row.my-msg {
            justify-content: flex-end;
        }
        .msg-row.my-msg .msg-bubble {
            background-color: #ffe066; /* é»„è‰²æ°”æ³¡æ¨¡æ‹Ÿ Kakao/Bubble */
            color: #000;
            border-radius: 12px;
            padding: 8px 12px;
            max-width: 70%;
            word-wrap: break-word;
            font-size: 14px;
        }
        .msg-row.my-msg img {
            max-width: 150px;
            border-radius: 10px;
        }

        /* ç¿»è¯‘æ ·å¼ - æ•´åˆåˆ°æ°”æ³¡å†… */
        .trans-divider {
            border-top: 1px dashed #aaa;
            margin-top: 6px;
            padding-top: 6px;
            font-size: 12px;
            color: #666;
        }

        /* é‡è¦ï¼šARTIST è§†è§’æŸ¥çœ‹è‡ªå·±çš„æ¶ˆæ¯ - æ›´ç´§å‡‘çš„æ ·å¼ */
        .msg-row.artist-view-mode {
            justify-content: flex-start; /* å˜åˆ°å·¦è¾¹ */
            margin-bottom: 5px; /* æ›´ç´§å‡‘ */
        }
        
        .msg-row.artist-view-mode .avatar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-right: 8px; /* æ›´ç´§å‡‘ */
        }

        /* ä¿®æ”¹ï¼šèŠå¤©å®¤å¤´åƒå¤–åœˆ */
        .msg-row.artist-view-mode .avatar-wrapper {
            position: relative;
            padding: 2px; /* æ›´ç»†çš„è¾¹æ¡† */
            border-radius: 50%; /* æ”¹ä¸ºåœ†å½¢ */
            background: var(--artist-gradient); /* æ¸å˜è¾¹æ¡† */
        }
        
        /* ä¿®æ”¹ï¼šèŠå¤©å®¤å¤´åƒå›¾ç‰‡æœ¬èº« */
        .msg-row.artist-view-mode .avatar-wrapper img {
            display: block;
            width: 34px; /* å‡å°2pxï¼Œå¢åŠ å†…è¾¹è· */
            height: 34px; /* å‡å°2pxï¼Œå¢åŠ å†…è¾¹è· */
            border-radius: 50%; /* æ”¹ä¸ºåœ†å½¢ */
            background: #fff; /* é˜²æ­¢é€æ˜ */
            object-fit: cover;
        }
        
        /* ä¿®æ”¹ï¼šå¤´åƒå¤–åœˆï¼ˆæ¸å˜è¾¹æ¡†ï¼‰ */
        .msg-row.artist-view-mode .avatar-wrapper {
            position: relative;
            padding: 2px; /* å¤´åƒå’Œè¾¹æ¡†ä¹‹é—´çš„è·ç¦» */
            border-radius: 50%; /* æ”¹ä¸ºåœ†å½¢ */
            background: var(--artist-gradient); /* æ¸å˜é¢œè‰² */
            display: flex; /* ç¡®ä¿å›¾ç‰‡å±…ä¸­ */
            align-items: center;
            justify-content: center;
        }

        /* ä¿®æ”¹ï¼šå¤´åƒå›¾ç‰‡æœ¬èº« */
        .msg-row.artist-view-mode .avatar-wrapper img {
            display: block;
            width: 40px;
            height: 40px;
            border-radius: 50%; /* æ”¹ä¸ºåœ†å½¢ */
            border: 3px solid #abc1d1; 
            object-fit: cover;
            background: #fff;
        }

        .msg-row.artist-view-mode .msg-content-col {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            max-width: 75%;
        }

        .msg-row.artist-view-mode .name-row {
            display: flex;
            align-items: center;
            margin-bottom: 2px; /* æ›´ç´§å‡‘ */
            gap: 3px; /* æ›´ç´§å‡‘ */
        }

        .msg-row.artist-view-mode .artist-badge-small {
            background: var(--artist-gradient);
            color: white;
            font-size: 9px;
            padding: 1px 5px; /* æ›´ç´§å‡‘ */
            border-radius: 8px; /* æ”¹ä¸ºæ¤­åœ†å½¢ */
            margin-right: 3px; /* æ›´ç´§å‡‘ */
            font-weight: bold;
            min-width: 48px; /* æ›´å° */
            text-align: center;
            letter-spacing: 0.3px; /* å‡å°å­—æ¯é—´è· */
        }

        .msg-row.artist-view-mode .name-text {
            font-size: 11px; /* æ›´å° */
            color: #333;
            font-weight: 500;
        }

        .msg-row.artist-view-mode .msg-bubble {
            background-color: #fff;
            color: #000;
            border-radius: 12px;
            padding: 6px 10px; /* æ›´ç´§å‡‘ */
            max-width: 100%;
            word-wrap: break-word;
            font-size: 13px; /* æ›´å° */
        }
        .msg-row.artist-view-mode .msg-bubble img {
            max-width: 140px; /* æ›´å° */
            border-radius: 8px; /* æ›´å° */
        }

        /* åº•éƒ¨è¾“å…¥æ  */
        .chat-input-area {
            background: #fff;
            padding: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-top: 1px solid #eee;
        }

        .plus-btn {
            font-size: 24px;
            color: #888;
            cursor: pointer;
            position: relative;
            background: transparent !important; /* ç¡®ä¿æ²¡æœ‰é»‘è‰²èƒŒæ™¯ */
            -webkit-tap-highlight-color: transparent;
        }

        /* Plus Menu */
        .plus-menu {
            position: absolute;
            bottom: 50px;
            left: 10px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            display: none;
            padding: 10px;
            flex-direction: row;
            gap: 15px;
            z-index: 100;
        }
        .plus-menu.show {
            display: flex;
        }
        .plus-menu-item {
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.2s;
            background: transparent !important;
            -webkit-tap-highlight-color: transparent;
        }
        .plus-menu-item:active {
            background-color: rgba(0,0,0,0.1) !important;
        }

        .chat-input-box {
            flex: 1;
            background: #f2f2f2;
            border-radius: 20px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
        }
        .chat-input-box input {
            border: none;
            background: transparent;
            flex: 1;
            outline: none;
            font-size: 16px;
        }

        .send-btn-icon {
            font-size: 20px;
            color: #888;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .paper-plane {
             transform: rotate(0deg);
        }

        /* è®¾ç½®èœå• (Modal) */
        .settings-modal {
            position: absolute;
            top: 0;
            right: 0;
            width: 70%;
            height: 100%;
            background: #fff;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 1600;
            display: flex;
            flex-direction: column;
        }
        .settings-modal.open {
            transform: translateX(0);
        }
        
        .settings-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            font-size: 14px;
            display: flex;
            flex-direction: column;
        }
        .settings-label {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .lang-options {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            display: none; /* hidden by default */
        }
        .lang-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 12px;
        }
        .lang-btn.selected {
            background: #eee;
            border-color: #999;
        }

        /* ==================== PAGE 3: MORE ==================== */
        .more-header {
            padding: 15px 20px;
            font-size: 24px;
            font-weight: 800;
        }
        
        .more-profile {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        /* ä¿®æ”¹ï¼šå¤§å¤´åƒæ”¹ä¸ºåœ†å½¢ */
        .big-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%; /* æ”¹ä¸ºåœ†å½¢ */
            background: var(--primary-blue);
            margin-bottom: 10px;
            object-fit: cover;
            cursor: pointer;
        }
        
        .more-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }
        .more-email {
            color: gray;
            font-size: 12px;
        }

        .more-list {
            padding: 0 20px;
        }
        .more-list-item {
            padding: 15px 0;
            border-bottom: 1px solid #eee;
            font-size: 16px;
            color: #333;
        }

        /* æ–°å¢ï¼šèŠå¤©åˆ—è¡¨å¤´åƒæ›´æ¢æŒ‰é’® */
        .change-chat-avatar-btn {
            position: absolute;
            right: 20px;
            font-size: 16px;
            color: #007aff;
            cursor: pointer;
            padding: 5px;
        }
        
        /* æ–°å¢ï¼šèŠå¤©å®¤å¤´åƒæ›´æ¢ç›¸å…³æ ·å¼ */
        .chat-avatar-container {
            position: relative;
            display: inline-block;
        }
        
        .change-chat-avatar-input {
            display: none;
        }

    </style>
</head>
<body>

    <div class="status-bar-spacer"></div>

    <div id="page-friends" class="page active">
        <div class="header-bar">
            <div class="header-title">FRIENDS</div>
            <div class="header-icons">
                <i class="fa-solid fa-magnifying-glass"></i>
                <i class="fa-regular fa-store"></i> </div>
        </div>
        
        <div class="profile-section">
            <img src="" class="small-avatar user-avatar-img" onclick="openProfileEdit()">
            <div class="profile-info">
                <h3 class="user-name-text">ï¼ˆÕâ¸â¸â¦á‘-â¸â¸.Õï¼‰</h3>
                <p class="user-bio-text">ğŸ–¤</p>
            </div>
        </div>
    </div>

    <div id="page-chats" class="page">
        <div class="header-bar">
            <div class="header-title">CHATS</div>
            <div class="header-icons">
                <i class="fa-solid fa-magnifying-glass"></i>
                <i class="fa-regular fa-trash-can"></i>
            </div>
        </div>

        <div class="chat-list-item" onclick="openChatRoom()">
            <!-- èŠå¤©åˆ—è¡¨å¤´åƒï¼Œå¯æ›´æ¢ -->
            <div class="chat-avatar-container">
                <img src="" id="chat-list-avatar-img" class="chat-list-avatar" 
                     style="cursor:pointer;"
                     onclick="event.stopPropagation(); document.getElementById('chat-list-avatar-input').click();">
                <input type="file" id="chat-list-avatar-input" accept="image/*" class="change-chat-avatar-input" 
                       onchange="changeChatListAvatar(this)">
            </div>
            <div class="profile-info">
                <h3 id="list-room-name">ì€ì€</h3>
                <p style="color:#888; font-size:12px;">Hello!</p>
            </div>
        </div>
    </div>

    <div id="page-more" class="page">
        <div class="more-header">MORE</div>
        <div class="more-profile">
            <img src="" class="big-avatar user-avatar-img" onclick="openProfileEdit()">
            <div class="more-name user-name-text">ï¼ˆÕâ¸â¸â¦á‘-â¸â¸.Õï¼‰</div>
            <div class="more-email">user@example.com</div>
        </div>
        <div class="more-list">
            <div class="more-list-item">My bubble</div>
            <div class="more-list-item">STORE</div>
            <div class="more-list-item">Notice</div>
            <div class="more-list-item">FAQ</div>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab('friends', this)">
            <i class="fa-solid fa-user"></i>
        </div>
        <div class="nav-item chat-icon" onclick="switchTab('chats', this)">
            <i class="fa-regular fa-comment"></i>
        </div>
        <div class="nav-item" onclick="switchTab('more', this)">
            <i class="fa-solid fa-ellipsis"></i>
        </div>
    </div>

    <div id="edit-profile-page">
        <input type="file" id="bg-file-input" accept="image/*" onchange="changeProfileBg(this)">
        <div style="position:absolute; width:100%; height:100%; z-index:-1;" onclick="document.getElementById('bg-file-input').click()"></div>
        
        <div class="edit-close-btn" onclick="closeProfileEdit()">
            <i class="fa-solid fa-xmark"></i>
        </div>

        <div class="profile-content-wrapper">
            <input type="file" id="avatar-file-input" accept="image/*" onchange="changeAvatar(this)">
            <img src="" class="big-avatar user-avatar-img" style="border: 2px solid white; width:80px; height:80px; margin-bottom:10px;" onclick="document.getElementById('avatar-file-input').click()">
            
            <div class="artist-badge-row">
                <div class="artist-badge">ARTIST</div>
                <div class="profile-name-display user-name-text" contenteditable="true" onblur="saveText(this, 'name')">ï¼ˆÕâ¸â¸â¦á‘-â¸â¸.Õï¼‰</div>
            </div>
            
            <div class="profile-desc-display user-bio-text" contenteditable="true" onblur="saveText(this, 'bio')">ğŸ–¤</div>

            <div class="white-border-box" contenteditable="true" id="bubble-tag-text">
                Stray Kids Â· HYUNJIN
            </div>
        </div>
    </div>

    <div id="chat-room-page">
        <div class="chat-room-header">
            <div onclick="closeChatRoom()" style="font-size: 20px; cursor:pointer;"><i class="fa-solid fa-chevron-left"></i></div>
            <div style="font-weight:bold;" id="chat-header-title">ì€ì€</div>
            <div style="display:flex; gap:15px;">
                <i class="fa-solid fa-magnifying-glass"></i>
                <i class="fa-solid fa-bars" onclick="toggleSettings()"></i>
            </div>
        </div>

        <div class="settings-modal" id="settings-modal">
            <div style="padding:15px; border-bottom:1px solid #eee; text-align:right;">
                <i class="fa-solid fa-xmark" onclick="toggleSettings()" style="font-size:20px;"></i>
            </div>
            <div class="settings-item">
                <div class="settings-label">èŠå¤©å®¤åç§°</div>
                <input type="text" id="room-name-input" value="ì€ì€" oninput="updateRoomName(this.value)" style="border:1px solid #ccc; padding:5px;">
            </div>
            <div class="settings-item" onclick="document.getElementById('chat-bg-input').click()" style="cursor:pointer;">
                <div class="settings-label">è®¾ç½®èƒŒæ™¯ (ç‚¹å‡»æ›´æ¢)</div>
                <input type="file" id="chat-bg-input" accept="image/*" style="display:none" onchange="changeChatBg(this)">
            </div>
            <div class="settings-item">
                <div class="settings-label" style="display:flex; justify-content:space-between;">
                    ç¿»è¯‘ <input type="checkbox" id="trans-toggle" onchange="toggleTransOptions(this)">
                </div>
                <div class="lang-options" id="lang-options">
                    <div class="lang-btn" onclick="selectLang('zh')">ä¸­</div>
                    <div class="lang-btn" onclick="selectLang('kr')">éŸ©</div>
                    <div class="lang-btn" onclick="selectLang('jp')">æ—¥</div>
                </div>
            </div>
            <div class="settings-item" onclick="clearChat()" style="color:red; margin-top:auto; border-top:1px solid #eee;">
                <i class="fa-solid fa-arrow-right-from-bracket"></i> é€€å‡ºèŠå¤©å®¤
            </div>
        </div>

        <div class="chat-room-bg" id="chat-bg-layer">
            <div class="days-counter">
                <span class="days-heart"><i class="fa-solid fa-heart"></i></span> 100
            </div>
            
            <div class="messages-area" id="messages-area">
                </div>
        </div>

        <div class="chat-input-area">
            <div class="plus-btn" onclick="togglePlusMenu()">
                <i class="fa-solid fa-plus"></i>
                <div class="plus-menu" id="plus-menu">
                    <div class="plus-menu-item" onclick="triggerChatImage()">â™¡</div>
                    <div class="plus-menu-item" onclick="togglePerspective()">ì‘</div>
                </div>
                <input type="file" id="chat-img-input" accept="image/*" style="display:none" onchange="sendImage(this)">
            </div>
            
            <div class="chat-input-box">
                <input type="text" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
                <i class="fa-regular fa-face-smile" style="color:#888; cursor:pointer;"></i>
            </div>
            
            <div class="send-btn-icon" onclick="sendText()">
                <i class="fa-solid fa-paper-plane paper-plane"></i> </div>
        </div>
    </div>

    <script>
        // --- å…¨å±€çŠ¶æ€ ---
        const state = {
            name: "ï¼ˆÕâ¸â¸â¦á‘-â¸â¸.Õï¼‰",
            bio: "ğŸ–¤",
            bubbleTag: "Stray Kids Â· HYUNJIN",
            avatar: "", // empty means default blue
            profileBg: "", // empty means default gray
            chatBg: "",
            roomName: "ì€ì€",
            translationOn: false,
            targetLang: 'zh',
            isArtistPerspective: false, // "ì‘" mode
            chatListAvatar: "" // èŠå¤©åˆ—è¡¨å¤´åƒ
        };

        // ç¿»è¯‘æ˜ å°„è¡¨
        const translationMap = {
            'zh': {
                'Hello!': 'ä½ å¥½ï¼',
                'How are you?': 'ä½ å¥½å—ï¼Ÿ',
                'I love this song!': 'æˆ‘å–œæ¬¢è¿™é¦–æ­Œï¼',
                'Good morning': 'æ—©ä¸Šå¥½',
                'See you tomorrow': 'æ˜å¤©è§',
                'Thank you': 'è°¢è°¢'
            },
            'kr': {
                'Hello!': 'ì•ˆë…•í•˜ì„¸ìš”!',
                'How are you?': 'ì–´ë–»ê²Œ ì§€ë‚´ì„¸ìš”?',
                'I love this song!': 'ì´ ë…¸ë˜ ì¢‹ì•„í•´ìš”!',
                'Good morning': 'ì¢‹ì€ ì•„ì¹¨',
                'See you tomorrow': 'ë‚´ì¼ ë´ìš”',
                'Thank you': 'ê°ì‚¬í•©ë‹ˆë‹¤'
            },
            'jp': {
                'Hello!': 'ã“ã‚“ã«ã¡ã¯ï¼',
                'How are you?': 'ãŠå…ƒæ°—ã§ã™ã‹ï¼Ÿ',
                'I love this song!': 'ã“ã®æ­ŒãŒå¤§å¥½ãã§ã™ï¼',
                'Good morning': 'ãŠã¯ã‚ˆã†ã”ã–ã„ã¾ã™',
                'See you tomorrow': 'ã¾ãŸæ˜æ—¥',
                'Thank you': 'ã‚ã‚ŠãŒã¨ã†'
            }
        };

        // --- åˆå§‹åŒ– ---
        window.onload = function() {
            // è®¾ç½®é»˜è®¤è“è‰²å¤´åƒ
            const avatars = document.querySelectorAll('.user-avatar-img');
            avatars.forEach(img => {
                if(!state.avatar) img.style.backgroundColor = "#007aff";
            });
            
            // è®¾ç½®èŠå¤©åˆ—è¡¨é»˜è®¤å¤´åƒ
            const chatListAvatar = document.getElementById('chat-list-avatar-img');
            if(!state.chatListAvatar) chatListAvatar.style.backgroundColor = "#CCCCCC";
        };

        // --- åº•éƒ¨å¯¼èˆªåˆ‡æ¢ ---
        function switchTab(tabName, el) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('page-' + tabName).classList.add('active');
            el.classList.add('active');
        }

        // --- ä¸ªäººä¸»é¡µç¼–è¾‘ ---
        function openProfileEdit() {
            const page = document.getElementById('edit-profile-page');
            page.style.display = 'block';
            // Sync current data to edit page
            document.querySelector('.profile-name-display').innerText = state.name;
            document.querySelector('.profile-desc-display').innerText = state.bio;
        }

        function closeProfileEdit() {
            document.getElementById('edit-profile-page').style.display = 'none';
        }

        function changeProfileBg(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    state.profileBg = e.target.result;
                    document.getElementById('edit-profile-page').style.backgroundImage = `url(${state.profileBg})`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function changeAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    state.avatar = e.target.result;
                    document.querySelectorAll('.user-avatar-img').forEach(img => {
                        img.src = state.avatar;
                        img.style.backgroundColor = 'transparent'; // Remove default blue
                    });
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function saveText(el, type) {
            if(type === 'name') {
                state.name = el.innerText;
                document.querySelectorAll('.user-name-text').forEach(t => t.innerText = state.name);
            } else if (type === 'bio') {
                state.bio = el.innerText;
                document.querySelectorAll('.user-bio-text').forEach(t => t.innerText = state.bio);
            }
        }

        // --- èŠå¤©å®¤åŠŸèƒ½ ---
        function openChatRoom() {
            document.getElementById('chat-room-page').style.display = 'flex';
        }

        function closeChatRoom() {
            document.getElementById('chat-room-page').style.display = 'none';
        }

        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('open');
        }

        function updateRoomName(val) {
            state.roomName = val;
            document.getElementById('chat-header-title').innerText = val;
            document.getElementById('list-room-name').innerText = val;
        }

        function changeChatBg(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    state.chatBg = e.target.result;
                    document.getElementById('chat-bg-layer').style.backgroundImage = `url(${state.chatBg})`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // æ–°å¢ï¼šæ›´æ¢èŠå¤©åˆ—è¡¨å¤´åƒ
        function changeChatListAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    state.chatListAvatar = e.target.result;
                    const chatListAvatarImg = document.getElementById('chat-list-avatar-img');
                    chatListAvatarImg.src = state.chatListAvatar;
                    chatListAvatarImg.style.backgroundColor = 'transparent';
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleTransOptions(checkbox) {
            state.translationOn = checkbox.checked;
            document.getElementById('lang-options').style.display = checkbox.checked ? 'flex' : 'none';
            // å¦‚æœå¼€å¯äº†ç¿»è¯‘ï¼Œé‡æ–°æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
            if(state.translationOn) {
                applyTranslationToAllMessages();
            } else {
                // å¦‚æœå…³é—­ç¿»è¯‘ï¼Œæ¢å¤åŸå§‹æ¶ˆæ¯
                restoreOriginalMessages();
            }
        }

        function selectLang(lang) {
            state.targetLang = lang;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('selected'));
            event.target.classList.add('selected');
            
            // å¦‚æœç¿»è¯‘å·²å¼€å¯ï¼Œç«‹å³åº”ç”¨æ–°è¯­è¨€çš„ç¿»è¯‘
            if(state.translationOn) {
                applyTranslationToAllMessages();
            }
        }

        // åº”ç”¨ç¿»è¯‘åˆ°æ‰€æœ‰æ¶ˆæ¯
        function applyTranslationToAllMessages() {
            const allMsgBubbles = document.querySelectorAll('.msg-bubble');
            allMsgBubbles.forEach(bubble => {
                const originalText = bubble.getAttribute('data-original') || bubble.childNodes[0]?.nodeValue?.trim();
                if(originalText) {
                    // ä¿å­˜åŸå§‹æ–‡æœ¬
                    if(!bubble.getAttribute('data-original')) {
                        bubble.setAttribute('data-original', originalText);
                    }
                    
                    // è·å–ç¿»è¯‘
                    const translatedText = translationMap[state.targetLang]?.[originalText] || originalText;
                    
                    // æ›´æ–°æ˜¾ç¤º
                    if(bubble.querySelector('.trans-divider')) {
                        // å¦‚æœå·²æœ‰ç¿»è¯‘åˆ†éš”çº¿ï¼Œæ›´æ–°ç¿»è¯‘éƒ¨åˆ†
                        bubble.childNodes[0].nodeValue = originalText;
                        bubble.querySelector('.trans-divider').innerText = translatedText;
                    } else {
                        // å¦‚æœæ²¡æœ‰ç¿»è¯‘åˆ†éš”çº¿ï¼Œæ·»åŠ ä¸€ä¸ª
                        const separator = document.createElement('div');
                        separator.className = 'trans-divider';
                        separator.innerText = translatedText;
                        
                        // æ¸…ç©ºæ°”æ³¡å†…å®¹å¹¶é‡æ–°æ·»åŠ 
                        const textNode = document.createTextNode(originalText);
                        bubble.innerHTML = '';
                        bubble.appendChild(textNode);
                        bubble.appendChild(separator);
                    }
                }
            });
        }

        // æ¢å¤åŸå§‹æ¶ˆæ¯
        function restoreOriginalMessages() {
            const allMsgBubbles = document.querySelectorAll('.msg-bubble');
            allMsgBubbles.forEach(bubble => {
                const originalText = bubble.getAttribute('data-original');
                if(originalText) {
                    // ç§»é™¤ç¿»è¯‘åˆ†éš”çº¿
                    const transDiv = bubble.querySelector('.trans-divider');
                    if(transDiv) {
                        transDiv.remove();
                    }
                    
                    // æ¢å¤åŸå§‹æ–‡æœ¬
                    bubble.childNodes[0].nodeValue = originalText;
                }
            });
        }

        function clearChat() {
            if(confirm("ç¡®å®šé€€å‡ºå¹¶æ¸…é™¤èŠå¤©è®°å½•å—ï¼Ÿ")) {
                document.getElementById('messages-area').innerHTML = '';
                // Clear BG
                state.chatBg = "";
                document.getElementById('chat-bg-layer').style.backgroundImage = "";
                toggleSettings(); // close menu
                closeChatRoom(); // go back
            }
        }

        // --- æ¶ˆæ¯å‘é€é€»è¾‘ ---
        function togglePlusMenu() {
            document.getElementById('plus-menu').classList.toggle('show');
        }

        function triggerChatImage() {
            document.getElementById('chat-img-input').click();
            togglePlusMenu();
        }

        function sendImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    addMessage(null, e.target.result);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function sendText() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(text) {
                addMessage(text, null);
                input.value = '';
            }
        }

        function addMessage(text, imgSrc) {
            const container = document.getElementById('messages-area');
            const msgRow = document.createElement('div');
            
            // åŸºç¡€ç±»ï¼šmy-msg (é»˜è®¤ä¹Ÿæ˜¯è‡ªå·±çš„æ¶ˆæ¯)
            msgRow.className = 'msg-row my-msg';

            // å¦‚æœå½“å‰æ˜¯"ì‘"æ¨¡å¼ï¼Œç›´æ¥æ·»åŠ  artist-view-mode ç±»
            if(state.isArtistPerspective) {
                msgRow.classList.add('artist-view-mode');
            }

            let contentHTML = '';

            // å¦‚æœæ˜¯"ì‘"æ¨¡å¼ (å¯¹æ–¹è§†è§’çœ‹è‡ªå·±)
            if(state.isArtistPerspective) {
                // éœ€è¦æ„å»ºå¤´åƒã€Badgeç»“æ„
                const avatarSrc = state.avatar || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; 
                
                let innerContent = '';
                if(text) {
                    // ä¿å­˜åŸå§‹æ–‡æœ¬
                    const translatedText = state.translationOn ? 
                        (translationMap[state.targetLang]?.[text] || text) : text;
                    
                    innerContent = `<div class="msg-bubble" data-original="${text}">${text}`;
                    if(state.translationOn) {
                        innerContent += `<div class="trans-divider">${translatedText}</div>`;
                    }
                    innerContent += `</div>`;
                } else if(imgSrc) {
                    innerContent = `<div class="msg-bubble"><img src="${imgSrc}" style="max-width:150px; border-radius:10px;"></div>`;
                }

                contentHTML = `
                    <div class="avatar-container">
                        <div class="avatar-wrapper">
                            <img src="${avatarSrc}">
                        </div>
                    </div>
                    <div class="msg-content-col">
                        <div class="name-row">
                            <span class="artist-badge-small">ARTIST</span>
                            <span class="name-text">${state.name}</span>
                        </div>
                        ${innerContent}
                    </div>
                `;
            } else {
                // æ­£å¸¸è§†è§’ (è‡ªå·±åœ¨å³è¾¹)
                if(text) {
                    // ä¿å­˜åŸå§‹æ–‡æœ¬
                    const translatedText = state.translationOn ? 
                        (translationMap[state.targetLang]?.[text] || text) : text;
                    
                    contentHTML = `<div class="msg-bubble" data-original="${text}">${text}`;
                    if(state.translationOn) {
                        contentHTML += `<div class="trans-divider">${translatedText}</div>`;
                    }
                    contentHTML += `</div>`;
                } else if(imgSrc) {
                    contentHTML = `<img src="${imgSrc}">`;
                }
            }

            msgRow.innerHTML = contentHTML;
            container.appendChild(msgRow);
            container.scrollTop = container.scrollHeight;
        }

        // --- æ ¸å¿ƒï¼šè§†è§’åˆ‡æ¢ (ì‘) ---
        function togglePerspective() {
            state.isArtistPerspective = !state.isArtistPerspective;
            
            // æç¤ºç”¨æˆ·
            const menu = document.getElementById('plus-menu');
            menu.classList.remove('show');
            
            // é‡æ–°æ¸²æŸ“æ‰€æœ‰ç°æœ‰çš„æ¶ˆæ¯
            const allMsgs = document.querySelectorAll('.msg-row');
            
            allMsgs.forEach(row => {
                // æå–å†…å®¹
                let rawText = "";
                let rawImgSrc = "";
                
                // æ£€æŸ¥å½“å‰æ˜¯å“ªç§æ¨¡å¼
                const isCurrentlyArtistMode = row.classList.contains('artist-view-mode');
                
                // è·å–æ ¸å¿ƒæ•°æ®
                if (isCurrentlyArtistMode) {
                    // ä» Artist ç»“æ„æå–
                    const b = row.querySelector('.msg-bubble');
                    if(b) {
                        // ä»data-originalå±æ€§è·å–åŸå§‹æ–‡æœ¬
                        rawText = b.getAttribute('data-original') || '';
                        if(!rawText) {
                            // å¦‚æœæ²¡æœ‰data-originalï¼Œä»æ–‡æœ¬èŠ‚ç‚¹è·å–
                            const textContent = b.childNodes[0];
                            if(textContent && textContent.nodeType === 3) {
                                rawText = textContent.nodeValue.trim();
                            }
                        }
                    }
                    const cImg = row.querySelector('.msg-bubble img');
                    if(cImg) rawImgSrc = cImg.src;
                } else {
                    // ä» Normal ç»“æ„æå–
                    const b = row.querySelector('.msg-bubble');
                    if(b) {
                        // ä»data-originalå±æ€§è·å–åŸå§‹æ–‡æœ¬
                        rawText = b.getAttribute('data-original') || '';
                        if(!rawText) {
                            // å¦‚æœæ²¡æœ‰data-originalï¼Œä»æ–‡æœ¬èŠ‚ç‚¹è·å–
                            const textContent = b.childNodes[0];
                            if(textContent && textContent.nodeType === 3) {
                                rawText = textContent.nodeValue.trim();
                            }
                        }
                    }
                    const cImg = row.querySelector('img');
                    if(cImg) rawImgSrc = cImg.src;
                }
                
                // æ¸…ç©ºè¿™è¡Œ
                row.innerHTML = '';
                row.classList.remove('artist-view-mode', 'my-msg');
                row.className = 'msg-row my-msg';
                
                // æ ¹æ® state.isArtistPerspective é‡å»º
                if(state.isArtistPerspective) {
                    row.classList.add('artist-view-mode');
                    const avatarSrc = state.avatar || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
                    
                    let inner = '';
                    if(rawText) {
                        // è·å–ç¿»è¯‘æ–‡æœ¬
                        const translatedText = state.translationOn ? 
                            (translationMap[state.targetLang]?.[rawText] || rawText) : rawText;
                        
                        inner = `<div class="msg-bubble" data-original="${rawText}">${rawText}`;
                        if(state.translationOn) inner += `<div class="trans-divider">${translatedText}</div>`;
                        inner += `</div>`;
                    } else if(rawImgSrc) {
                        inner = `<div class="msg-bubble"><img src="${rawImgSrc}" style="max-width:150px; border-radius:10px;"></div>`;
                    }
                    
                    row.innerHTML = `
                        <div class="avatar-container">
                            <div class="avatar-wrapper">
                                <img src="${avatarSrc}">
                            </div>
                        </div>
                        <div class="msg-content-col">
                            <div class="name-row">
                                <span class="artist-badge-small">ARTIST</span>
                                <span class="name-text">${state.name}</span>
                            </div>
                            ${inner}
                        </div>
                    `;
                    
                } else {
                    row.classList.remove('artist-view-mode');
                    let inner = '';
                    if(rawText) {
                        // è·å–ç¿»è¯‘æ–‡æœ¬
                        const translatedText = state.translationOn ? 
                            (translationMap[state.targetLang]?.[rawText] || rawText) : rawText;
                        
                        inner = `<div class="msg-bubble" data-original="${rawText}">${rawText}`;
                        if(state.translationOn) inner += `<div class="trans-divider">${translatedText}</div>`;
                        inner += `</div>`;
                    }
                    else if(rawImgSrc) inner = `<img src="${rawImgSrc}">`;
                    row.innerHTML = inner;
                }
            });
            
            // æé†’ç”¨æˆ·
            // alert(state.isArtistPerspective ? "å·²åˆ‡æ¢è‡³å¯¹æ–¹è§†è§’" : "å·²åˆ‡æ¢å›è‡ªå·±è§†è§’");
        }

    </script>
</body>
</html>

